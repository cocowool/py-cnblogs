
<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="referrer" content="origin" />
<title>Minikube体验 - Cocowool - 博客园</title>
<meta property="og:description" content="本文的环境如下： 操作系统： Mac OSX EI Caption Docker：Docker version 18.03.1 ce, build 9ee9f40 Minikube：minikube " />
<link type="text/css" rel="stylesheet" href="/bundles/blog-common.css?v=-duj5vpGTntb85GJoM3iRI972XwWcI-j8zmqDzyfu2w1"/>
<link type="text/css" rel="stylesheet" href="/blog/customcss/43046.css?v=jIe%2bqkoe6NGEDBHSKfZFtSP%2bk3Q%3d"/>
<link id="mobile-style" media="only screen and (max-width: 767px)" type="text/css" rel="stylesheet" href="/skins/Custom/bundle-Custom-mobile.css?v=D4ZG96to-4HBTPc_nukUGx4UJPJRCpcXUrj8NiiyXiU1"/>
<link title="RSS" type="application/rss+xml" rel="alternate" href="https://www.cnblogs.com/cocowool/rss"/>
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="https://www.cnblogs.com/cocowool/rsd.xml"/>
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="https://www.cnblogs.com/cocowool/wlwmanifest.xml"/>
<script src="//common.cnblogs.com/scripts/jquery-2.2.0.min.js"></script>
<script type="text/javascript">var currentBlogApp = 'cocowool', cb_enable_mathjax=false;var isLogined=false;</script>
<script src="/bundles/blog-common.js?v=oVrWjmbP-rXxVp7O71kev8vWEZCetdwYaIziKHJCYc41" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>
<!--PageBeginHtml Block Begin-->
<div id="bgoverlay"></div>
<!--PageBeginHtml Block End-->

<!--done-->
<div id="home">
<div id="header">
	<div id="blogTitle">
	<a id="lnkBlogLogo" href="https://www.cnblogs.com/cocowool/"><img id="blogLogo" src="/Skins/custom/images/logo.gif" alt="返回主页" /></a>			
		
<!--done-->
<h1><a id="Header1_HeaderTitle" class="headermaintitle" href="https://www.cnblogs.com/cocowool/">小狼的世界</a></h1>
<h2>不积跬步，无以至千里、不积细流，无以成江海</h2>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li><a id="blog_nav_sitehome" class="menu" href="https://www.cnblogs.com/">博客园</a></li>
<li><a id="blog_nav_myhome" class="menu" href="https://www.cnblogs.com/cocowool/">首页</a></li>
<li></li>
<li><a id="blog_nav_contact" class="menu" rel="nofollow" href="https://msg.cnblogs.com/send/Cocowool">联系</a></li>
<li><a id="blog_nav_rss" class="menu" href="https://www.cnblogs.com/cocowool/rss">订阅</a>
<!--<a id="blog_nav_rss_image" class="aHeaderXML" href="https://www.cnblogs.com/cocowool/rss"><img src="//www.cnblogs.com/images/xml.gif" alt="订阅" /></a>--></li>
<li><a id="blog_nav_admin" class="menu" rel="nofollow" href="https://i.cnblogs.com/">管理</a></li>
</ul>
		<div class="blogStats">
			
			<div id="blog_stats">
<span id="stats_post_count">随笔 - 363&nbsp; </span>
<span id="stats_article_count">文章 - 4&nbsp; </span>
<span id="stats-comment_count">评论 - 449</span>
</div>
			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->

<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class = "post">
		<h1 class = "postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="https://www.cnblogs.com/cocowool/p/minikube_setup_and_first_sample.html">Minikube体验</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown"><blockquote>
<p>本文的环境如下：<br />
操作系统： Mac OSX EI Caption<br />
Docker：Docker version 18.03.1-ce, build 9ee9f40<br />
Minikube：minikube version: v0.27.0<br />
Kubernetes: v1.10.0</p>
</blockquote>
<h3 id="minikube-介绍">Minikube 介绍</h3>
<p>Minikube支持Kubenetes的以下特性：</p>
<ul>
<li>DNS</li>
<li>NodePorts</li>
<li>ConfigMaps and Secrets</li>
<li>Dashboards</li>
<li>Container Runtime: Docker, rkt and CRI-O</li>
<li>Enabling CNI (Container Network Interface)</li>
<li>Ingress</li>
</ul>
<h3 id="minikube-安装">Minikube 安装</h3>
<p>因为 Google 在国内没办法访问，我使用了阿里版的 Minikube 。</p>
<p>Minikube运行要求安装有VirtualBox或VMWare Fusion，我用的是VirtualBox。</p>
<p>VirtualBox安装很简单，从 <a href="https://www.virtualbox.org">官方下载DMG</a> 安装即可。</p>
<h4 id="下载安装-minikube">下载安装 Minikube</h4>
<pre class="sh"><code>curl -Lo minikube http://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v0.27.0/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</code></pre>
<h4 id="启动-minikube">启动 Minikube</h4>
<pre class="sh"><code>minikube start --registry-mirror=https://registry.docker-cn.com</code></pre>
<blockquote>
<p>如果你遇到这个错误，<em>Error restarting cluster: restarting kube-proxy: waiting for kube-proxy to be up for configmap update: timed out waiting for the condition</em><br />
通过 minikube delete，minikube start 可以解决</p>
</blockquote>
<h4 id="打开-minikube-控制台">打开 Minikube 控制台</h4>
<pre class="sh"><code>minikube dashboard</code></pre>
<p>随后浏览器中会自动打开这个界面。<br />
<img src="https://images2018.cnblogs.com/blog/39469/201806/39469-20180619113017294-1321626965.png" /></p>
<h3 id="使用">使用</h3>
<p>Minikube在本地虚拟机环境中部署 Kubernetes。<br />
<img src="https://images2018.cnblogs.com/blog/39469/201806/39469-20180619113030619-1842549291.png" /></p>
<h4 id="启动-cluster">启动 Cluster</h4>
<pre class="sh"><code>bogon:k8s rousseau$ minikube start
Starting local Kubernetes v1.10.0 cluster...
Starting VM...
Getting VM IP address...
Moving files into cluster...
Setting up certs...
Connecting to cluster...
Setting up kubeconfig...
Starting cluster components...
Kubectl is now configured to use the cluster.
Loading cached images from config file.</code></pre>
<p>该命令创建并配置一个运行了单个Kubernetes节点的虚拟机。Minikube 启动过程中，可以用<code>--extra-config=component.key=value</code>的形式给 Kubernetes 指定参数。</p>
<h4 id="停止-cluster">停止 Cluster</h4>
<pre class="sh"><code>bogon:k8s rousseau$ minikube stop</code></pre>
<h4 id="删除-cluster">删除 Cluster</h4>
<pre class="sh"><code>bogon:k8s rousseau$ minikube delete</code></pre>
<h4 id="访问服务">访问服务</h4>
<pre class="sh"><code>minikube service [-n NAMESPACE] [--url] NAME</code></pre>
<h3 id="网络">网络</h3>
<p>前面的原理图说明了Minikube启动了一个虚拟机，这个虚拟机的地址是Host-Only的，要获得主机IP，执行。</p>
<pre class="sh"><code>bogon:k8s rousseau$ minikube ip
192.168.99.100</code></pre>
<h3 id="存储">存储</h3>
<h3 id="简单的示例">简单的示例</h3>
<h4 id="构建一个-node-服务">构建一个 Node 服务</h4>
<p>构建一个简单的Node网页程序，用户访问的时候输出hello world。</p>
<pre class="node"><code>var http = require(&#39;http&#39;);

var handleRequest = function(request, response) {
  console.log(&#39;Received request for URL: &#39; + request.url);
  response.writeHead(200);
  response.end(&#39;Hello World!&#39;);
};
var www = http.createServer(handleRequest);
www.listen(8080);</code></pre>
<p>可以在终端中执行<code>node server.js</code>并通过http://localhost:8080查看效果</p>
<h4 id="生成镜像">生成镜像</h4>
<p>编写 Dockerfile 文件</p>
<pre class="dockerfile"><code>FROM node:6.9.2
EXPOSE 8080
COPY server.js .
CMD node server.js</code></pre>
<p>因为我们使用的是 Minikube ，不需要把镜像放到镜像仓库中，只需要放在Minikube VM中。</p>
<pre class="sh"><code>bogon:k8s rousseau$ eval $(minikube docker-env)
bogon:k8s rousseau$ docker build -t hello-node:v1 .
Sending build context to Docker daemon  3.072kB
Step 1/4 : FROM node:6.9.2
6.9.2: Pulling from library/node
75a822cd7888: Pull complete 
57de64c72267: Pull complete 
4306be1e8943: Pull complete 
871436ab7225: Pull complete 
0110c26a367a: Pull complete 
1f04fe713f1b: Pull complete 
ac7c0b5fb553: Pull complete 
Digest: sha256:2e95be60faf429d6c97d928c762cb36f1940f4456ce4bd33fbdc34de94a5e043
Status: Downloaded newer image for node:6.9.2
 ---&gt; faaadb4aaf9b
Step 2/4 : EXPOSE 8080
 ---&gt; Running in a3229e6d0438
Removing intermediate container a3229e6d0438
 ---&gt; f8e1aa12de28
Step 3/4 : COPY server.js .
 ---&gt; 5254ea79c7a4
Step 4/4 : CMD node server.js
 ---&gt; Running in 060ef7e6f713
Removing intermediate container 060ef7e6f713
 ---&gt; 2fe0fd2e98d7
Successfully built 2fe0fd2e98d7
Successfully tagged hello-node:v1</code></pre>
<h4 id="部署">部署</h4>
<p>使用 <code>kubectl</code> 命令行部署应用。</p>
<pre class="sh"><code>bogon:k8s rousseau$ kubectl run hello-node --image=hello-node:v1 --port=8080
deployment.apps &quot;hello-node&quot; created
bogon:k8s rousseau$ kubectl get deployments
NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
hello-node   1         1         1            1           26s
bogon:k8s rousseau$ kubectl get pods
NAME                          READY     STATUS    RESTARTS   AGE
hello-node-658d8f6754-7mz28   1/1       Running   0          37s</code></pre>
<p>Pods在Kubernetes中是一组容器的集合，在这个例子中只有一个容器实例，所以看到的各项统计数字都是1。</p>
<h4 id="创建服务">创建服务</h4>
<p>默认情况下，Pod只能通过内部地址访问，为了让 hello-node 可以从外部访问，需要将Pod暴露为 Kubernetes 的服务。</p>
<pre class="sh"><code>bogon:k8s rousseau$ kubectl expose deployment hello-node --type=LoadBalancer
service &quot;hello-node&quot; exposed
bogon:k8s rousseau$ kubectl get services
NAME         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
hello-node   LoadBalancer   10.108.143.198   &lt;pending&gt;     8080:32386/TCP   7s
kubernetes   ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          1h</code></pre>
<p><code>--type=LoadBalancer</code>参数表示我们希望将我们的服务暴露在外面，在云的环境中支持负载均衡情况下，只需要提供负载均衡的地址。在Minikube中，<code>LoadBanlancer</code>类型让服务可以通过<code>minikube service</code>来访问</p>
<pre class="sh"><code>minikube service hello-node</code></pre>
<p>这个命令会自动打开浏览器窗口访问服务，使用本地IP。</p>
<h4 id="更新应用">更新应用</h4>
<p>假设我们更新了应用，输出新的一段话。</p>
<pre class="sh"><code>response.end(&#39;Hello World Again!&#39;);</code></pre>
<p>生成镜像</p>
<pre class="sh"><code>docker build -t hello-node:v2 .</code></pre>
<p>更新部署</p>
<pre class="sh"><code>kubectl set image deployment/hello-node hello-node=hello-node:v2</code></pre>
<p>查看更新</p>
<pre class="sh"><code>minikube service hello-node</code></pre>
<p>销毁服务</p>
<pre class="sh"><code>kubectl delete service hello-node
kubectl delete deployment hello-node</code></pre>
<p>参考资料：<br />
1、<a href="https://yq.aliyun.com/articles/221687">Minikube - Kubernetes本地实验环境</a><br />
2、<a href="https://kubernetes.io/docs/tutorials/hello-minikube/">Hello Minikube</a><br />
3、<a href="https://kubernetes.io/docs/setup/minikube/">Running Kubernetes Locally via Minikube</a><br />
4、<a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">Install Minikube</a></p>
</div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>


		</div>
		<div class = "postDesc">posted @ <span id="post-date">2018-06-19 11:31</span> <a href='https://www.cnblogs.com/cocowool/'>Cocowool</a> 阅读(<span id="post_view_count">...</span>) 评论(<span id="post_comment_count">...</span>)  <a href ="https://i.cnblogs.com/EditPosts.aspx?postid=9197813" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(9197813);return false;">收藏</a></div>
	</div>
	<script src="//common.cnblogs.com/highlight/9.12.0/highlight.min.js"></script><script>markdown_highlight();</script><script type="text/javascript">var allowComments=true,cb_blogId=43046,cb_entryId=9197813,cb_blogApp=currentBlogApp,cb_blogUserGuid='6151420b-63cf-dd11-9e4d-001cf0cd104b',cb_entryCreatedDate='2018/6/19 11:31:00';loadViewCount(cb_entryId);var cb_postType=1;</script>
	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id='comment_form' class='commentform'>
<a name='commentform'></a>
<div id='divCommentShow'></div>
<div id='comment_nav'><span id='span_refresh_tips'></span><a href='javascript:void(0);' onclick='return RefreshCommentList();' id='lnk_RefreshComments' runat='server' clientidmode='Static'>刷新评论</a><a href='#' onclick='return RefreshPage();'>刷新页面</a><a href='#top'>返回顶部</a></div>
<div id='comment_form_container'></div>
<div class='ad_text_commentbox' id='ad_text_under_commentbox'></div>
<div id='ad_t2'></div>
<div id='opt_under_post'></div>
<div id='cnblogs_c1' class='c_ad_block'></div>
<div id='under_post_news'></div>
<script async='async' src='https://www.googletagservices.com/tag/js/gpt.js'></script>
<script>
  var googletag = googletag || {};
  googletag.cmd = googletag.cmd || [];
</script>

<script>
  googletag.cmd.push(function() {
    googletag.defineSlot('/1090369/C2', [468, 60], 'div-gpt-ad-1539008685004-0').addService(googletag.pubads());
    googletag.pubads().enableSingleRequest();
    googletag.enableServices();
  });
</script>
<div id='cnblogs_c2' class='c_ad_block'>
    <div id='div-gpt-ad-1539008685004-0' style='height:60px; width:468px;'>
    <script>
    if (new Date() >= new Date(2018, 9, 13)) {
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1539008685004-0'); });
    }
    </script>
    </div>
</div>
<div id='under_post_kb'></div>
<div id='HistoryToday' class='c_ad_block'></div>
<script type='text/javascript'>
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverAdT2();
    deliverAdC1();
    deliverAdC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);   
</script>
</div>


	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="blog-calendar" style="display:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright &copy;2018 Cocowool
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
<!--PageEndHtml Block Begin-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?433c388afd6e0af1d67cfe808874c659";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!--PageEndHtml Block End-->
</body>
</html>
